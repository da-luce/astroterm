name: CI

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  # Special build that builds with profiling and coverage
  build-profile:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # Plus gcovr for code coverage
    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          python3-setuptools \
          ninja-build \
          build-essential \
          xxd \
          wget \
          pkg-config \
          libncurses-dev \
          libargtable2-dev
        pip3 install meson gcovr

    - name: Build for Linux x86_64
      env:
        CC: ${{ matrix.compiler }}
      run: |
        sh install.sh --coverage

    - name: Run Tests
      run: |
        meson test -v -C build

    - name: Generate Code Coverage Reports
      run: |
        ninja coverage-xml -C build

    - name: Upload Coverage
      uses: actions/upload-artifact@v3
      with:
        name: coverage
        path: build/meson-logs/coverage.xml

  build-linux:
    runs-on: ubuntu-20.04 # Use an older Ubuntu version to ensure compatibility with older C libraries
    strategy:
      matrix:
        compiler: [gcc, clang]
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # Plus gcovr for code coverage
    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          python3-setuptools \
          ninja-build \
          build-essential \
          xxd \
          wget \
          pkg-config \
          libncurses-dev \
          libargtable2-dev
        pip3 install meson gcovr

    - name: Build for Linux x86_64
      env:
        CC: ${{ matrix.compiler }}
      run: |
        sh install.sh

    - name: Run Tests
      run: |
        meson test -v -C build

    - name: Upload x86_64 Build Artifacts
      # Only use result of one compiler
      if: matrix.compiler == 'gcc'
      uses: actions/upload-artifact@v3
      with:
        name: astroterm-linux-x86_64
        path: build/astroterm

  run-linux:
    runs-on: ubuntu-latest
    needs: build-linux
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: astroterm-linux-x86_64
          path: astroterm-linux-x86_64

      - name: Make Executable
        run: |
          chmod +x astroterm-linux-x86_64/astroterm

      - name: Run Executable
        run: |
          ./astroterm-linux-x86_64/astroterm --version

  build-darwin:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, macos-13]
        arch: [aarch64, x86_64]
        exclude:
          - os: macos-latest
            arch: x86_64
          - os: macos-13
            arch : aarch64

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Build Dependencies
      run: |
        brew update
        brew install \
          meson \
          ninja \
          ncurses \
          argtable

    - name: Build for Darwin ${{ matrix.arch }}
      env:
        CC: clang
      run: |
        sh install.sh

    - name: Run Tests
      run: |
        meson test -v -C build

    - name: Upload Darwin ${{ matrix.arch }} Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: astroterm-darwin-${{ matrix.arch }}
        path: build/astroterm

  run-darwin:
    runs-on: ${{ matrix.os }}
    needs: build-darwin  # Ensure this depends on the build job
    strategy:
      matrix:
        os: [macos-latest, macos-13]
        arch: [aarch64, x86_64]
        exclude:
          - os: macos-latest
            arch: x86_64
          - os: macos-13
            arch: aarch64

    steps:
      - name: Download Darwin ${{ matrix.arch }} Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: astroterm-darwin-${{ matrix.arch }}

      - name: Make Executable
        run: |
          chmod +x astroterm

      - name: Run Executable
        run: |
          ./astroterm --version

  build-win:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, windows-2019]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install Python Dependencies
      run: pip install meson ninja

    - name: Prepare MSVC
      uses: bus1/cabuild/action/msdevshell@v1
      with:
        architecture: x64

    # I tried the 3.9 release, something broke, so sticking with cloning main for now
    - name: Clone and Build PDCurses
      run: |
        mkdir .\install\lib
        mkdir .\install\include
        cd .\install
        git clone https://github.com/wmcbrine/PDCurses/
        cd PDCurses\wincon
        nmake -f Makefile.vc WIDE=Y UTF8=Y
        copy pdcurses.lib ..\..\lib
        copy ..\curses.h ..\..\include
        copy ..\panel.h ..\..\include

    - name: Download and Build Argtable2
      run: |
        cd .\install
        curl -L -o argtable2-13.tar.gz http://prdownloads.sourceforge.net/argtable/argtable2-13.tar.gz
        tar -xzf argtable2-13.tar.gz
        cd .\argtable2-13\src
        nmake -f Makefile.nmake
        copy argtable2.lib ..\..\lib
        copy argtable2.h ..\..\include

    - name: Download BSC5
      run: curl -L -o data/bsc5 http://tdc-www.harvard.edu/catalogs/BSC5 || echo "bsc5 already exists or curl failed"

    - name: Build for Windows x86_64
      run: |
        meson setup build -Drelease_build=true
        meson compile -C build

    - name: Run Tests
      run: |
        meson test -v -C build

    - name: Upload Windows x86_64 Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: astroterm-win-x86_64
        path: build/astroterm.exe

  run-win:
    runs-on: windows-latest
    needs: build-win
    steps:
      - name: Download Windows Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: astroterm-win-x86_64

      - name: Run Executable
        run: |
          .\astroterm.exe --version

  code-quality:
    runs-on: ubuntu-latest
    needs: build-profile
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Code Quality Tools
      run: |
        sudo apt-get install -y cppcheck clang-format

    - name: Run Cppcheck
      run: |
        cppcheck \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=missingInclude \
          --suppress=style \
          --error-exitcode=1 \
          src/

    - name: Check Formatting
      run: |
        sh ./scripts/format.sh --check

  upload-coverage:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
    - name: Download Coverage Reports
      uses: actions/download-artifact@v3
      with:
        name: coverage
        path: coverage

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: coverage/coverage.xml
        fail_ci_if_error: true

  publish-release:
    runs-on: ubuntu-latest
    needs: [run-linux, run-darwin, run-win, code-quality, upload-coverage]
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    steps:

    - name: Download Build astroterm-linux-x86_64
      uses: actions/download-artifact@v3
      with:
        name: astroterm-linux-x86_64
        path: astroterm-linux-x86_64

    - name: Download Build astroterm-darwin-x86_64
      uses: actions/download-artifact@v3
      with:
        name: astroterm-darwin-x86_64
        path: astroterm-darwin-x86_64

    - name: Download Build astroterm-darwin-aarch64
      uses: actions/download-artifact@v3
      with:
        name: astroterm-darwin-aarch64
        path: astroterm-darwin-aarch64

    - name: Download Build astroterm-win-x84_64
      uses: actions/download-artifact@v3
      with:
        name: astroterm-win-x84_64
        path: astroterm-win-x84_64

    - name: Generate Changelog
      id: changelog
      uses: Requarks/changelog-action@v1
      with:
        token: ${{ github.token }}
        tag: ${{ github.ref_name }}
        writeToFile: false

    - name: Update GitHub Release
      uses: ncipollo/release-action@v1.12.0
      with:
        allowUpdates: true
        draft: true
        makeLatest: true
        name: ${{ github.ref_name }}
        body: ${{ steps.changelog.outputs.changes }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: 'astroterm-linux-x86_64,astroterm-darwin-aarch64,astroterm-darwin-x86_64,astroterm-win-x86_64'